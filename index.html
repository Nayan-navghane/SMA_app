const schoolSystem = new SchoolManagementSystem();

class SchoolManagementSystem {
    constructor() {
        this.students = JSON.parse(localStorage.getItem('students')) || [];
        this.teachers = JSON.parse(localStorage.getItem('teachers')) || [];
        this.salaries = JSON.parse(localStorage.getItem('salaries')) || [];
        this.admissions = JSON.parse(localStorage.getItem('admissions')) || [];
        this.attendance = JSON.parse(localStorage.getItem('attendance')) || {};
        this.exams = JSON.parse(localStorage.getItem('exams')) || [];
        this.schedules = JSON.parse(localStorage.getItem('schedules')) || {};
        this.activities = JSON.parse(localStorage.getItem('activities')) || [];
        this.settings = JSON.parse(localStorage.getItem('settings')) || this.getDefaultSettings();
        this.staff = JSON.parse(localStorage.getItem('staff')) || [];
        this.init();
    }

    getDefaultSettings() {
        return {
            schoolInfo: {
                name: 'Government School',
                code: 'GOVT001',
                address: 'Government School Address',
                phone: '123-456-7890',
                email: 'govt.school@example.com',
                website: 'govt.school.gov'
            },
            preferences: {
                theme: 'light',
                language: 'en',
                timezone: 'Asia/Kolkata',
                dateFormat: 'DD/MM/YYYY',
                autoBackup: false,
                notifications: true
            },
            security: {
                sessionTimeout: false
            }
        };
    }

    init() {
        this.setupEventListeners();
        this.loadDashboardData();
        this.populateFilters();
        this.setCurrentDate();
    }

    setCurrentDate() {
        const today = new Date().toISOString().split('T')[0];
        const dateInputs = document.querySelectorAll('input[type="date"]');
        dateInputs.forEach(input => {
            if (!input.value) {
                input.value = today;
            }
        });
    }

    populateFilters() {
        // Populate class filters
        const classes = [...new Set([...this.students, ...this.teachers].map(item => item.class || item.subject || '')).filter(cls => cls)].sort();
        const classSelectors = document.querySelectorAll('select[id$="Class"]');
        classSelectors.forEach(selector => {
            selector.innerHTML = '<option value="">All Classes</option>' + classes.map(cls => `<option value="${cls}">${cls}</option>`).join('');
        });

        // Populate subject filters
        const subjects = [...new Set(this.teachers.map(t => t.subject))].sort();
        const subjectSelectors = document.querySelectorAll('select[id$="Subject"]');
        subjectSelectors.forEach(selector => {
            selector.innerHTML = '<option value="">All Subjects</option>' + subjects.map(sub => `<option value="${sub}">${sub}</option>`).join('');
        });

        // Populate department filters
        const departments = [...new Set(this.staff.map(s => s.department))].sort();
        const departmentSelectors = document.querySelectorAll('select[id$="Department"]');
        departmentSelectors.forEach(selector => {
            selector.innerHTML = '<option value="">All Departments</option>' + departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
        });

        // Populate status filters
        const statusSelectors = document.querySelectorAll('select[id$="Status"]');
        statusSelectors.forEach(selector => {
            selector.innerHTML = '<option value="">All Status</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option>';
        });
    }

    setupEventListeners() {
        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.currentTarget.getAttribute('data-section');
                this.showSection(section);
            });
        });

        // Forms
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const formId = form.id;
                if (formId === 'studentForm') {
                    this.handleStudentSubmit(e);
                } else if (formId === 'teacherForm') {
                    this.handleTeacherSubmit(e);
                } else if (formId === 'salaryForm') {
                    this.handleSalarySubmit(e);
                } else if (formId === 'admissionForm') {
                    this.handleAdmissionSubmit(e);
                } else if (formId === 'schoolInfoForm') {
                    this.saveSchoolInfo(e);
                } else if (formId === 'systemPrefsForm') {
                    this.saveSystemPreferences(e);
                } else if (formId === 'securityForm') {
                    this.saveSecuritySettings(e);
                } else if (formId === 'extraExpenseForm') {
                    this.handleExtraExpenseSubmit(e);
                }
            });
        });

        // Excel upload
        const excelUpload = document.getElementById('excelUpload');
        if (excelUpload) {
            excelUpload.addEventListener('change', (e) => this.uploadSalaryExcel(e));
        }

        // Theme toggle
        const themeSelect = document.getElementById('theme');
        if (themeSelect) {
            themeSelect.addEventListener('change', (e) => {
                const theme
